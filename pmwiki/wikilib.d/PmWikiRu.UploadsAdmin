version=pmwiki-2.1.5 ordered=1 urlencoded=1
agent=Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.0.2) Gecko/20060308 Firefox/1.5.0.2
author=Holo
csum=translated
ctime=1146552321
host=195.98.173.2
name=PmWikiRu.UploadsAdmin
rev=1
targets=PmWikiRu.Uploads,PmWiki.PmWiki,PmWikiRu.WikiAdministrator,PmWikiRu.PasswordsAdmin,PmWikiRu.Passwords,PmWikiRu.PerGroupCustomizations,PmWikiRu.LocalCustomizations,PmWikiRu.DocumentationIndex
text=(:title Управление закачками:)%0a%0a[[PmWiki]] включает сценарий называемый ''upload.php'' позволяющий пользователям [[закачивать -> uploads]] файлы на вики сервер пользуясь веб броузером.  Закачаные файлы (по другому называемые ''вложения'') могут быть легко доступны в помощью разметки на вики страницах.  Эта страница рассказывается как установить и настроить функцию закачки.%0a%0a%0a!!Некоторые замечания по поводу безопасности%0a%0aОтносительно функции закачки PmWiki занимает отчасти параноидальную позу.  Соответственно, настройки по умолчанию для закачек тяготеют к стремлению ограничить эту функцию как можно сильнее:%0a%0a* Закачка по умолчанию запрещена%0a* Даже если её разрешить, она защищена паролем%0a* Даже если убрать пароль, вы ограничены закачкой файлов с определёнными именами и расширениями(типами)%0a* Символы применяемые в именах закачиваемых файлов (по умолчанию) это: буквы, минус, подчёркивание, точка и пробел.%0a* Максимальный размер закачиваемого файла весьма мал (по умолчанию 50K)%0a%0aВ таком исполнении возможность повреждений ограничена пока/если администратор вики явно не ослабит ограничения.%0a%0aИмейте в виду, что позволение пользователям (анонимно!) закачивать файлы на ваш веб сервер влечёт за собой некоторую долю риска.  Сценарий ''upload.php'' специально разработан для снижения риска, но [[администраторы вики -> wiki administrator]] должны знать, что потенциальная уязвимость существует, и что расконфигурация утилиты закачки может иметь нежелательные последствия.%0a%0aИзначально, авторизованым пользователям разрешена перезапись файлов до того уже закачаных без мозможности восстановления предыдущей версии файла.  Если вы хотите запретить пользователям перезаписывать файлы добавьте следующую строку в ''config.php'':%0a%0a->[@$EnableUploadOverwrite = 0;@]%0a%0aПо другому, администратор может [[#upload_versions|сохранить предыдущие версии]] закачек.%0a%0aТакже администратор может [[#direct_download|настроить]] PmWiki так, чтобы механизм паролей управлял доступом к закачаным файлам.%0a%0a%0a!!Базовая установка%0a%0aЕсли переменная $EnableUpload в ''config.php'' не равна нулю, то ''stdconfig.php'' автоматически подключает сценарий ''upload.php''.  К тому же,  папка для закачивания файлов и URL этой папки на сервере можно установить переменными $UploadDir и $UploadUrlFmt в ''config.php''.  Изначально, $UploadDir и $UploadUrlFmt предполагают, что закачаные файлы хранятся в папке с именем ''uploads/'' в текущей папке (обычно содержащую единственный ''pmwiki.php'').  Ко всему прочему, ''config.php'' также устанавливает начальный пароль закачки (смотри [[PasswordsAdmin|+]]).%0a%0aТаким образом, основной ''config.php'' для закачек может выглядеть так:%0a%0a->[@%0a%3c?php if (!defined('PmWiki')) exit();%0a##  Enable uploads and set a site-wide default upload password.%0a$EnableUpload = 1;%0a$DefaultPasswords['upload'] = crypt('secret');%0a@]%0a%0a'''Важно''': Не создавайте пока папку uploads. Читайте следующий параграф.%0a%0aВам может понадобиться явно установить папку для хранения закачек и указать URL отвечающий за эту папку:%0a%0a->[@%0a$UploadDir = "/home/john/public_html/uploads";%0a$UploadUrlFmt = [="http://www.john.com/~john/uploads";=]%0a@]%0a%0aЗакачки могут быть настроены переменной $UploadPrefixFmt для всего сайта, погруппно или постранично.  Она указывает будут ли все закачки храниться в одной папке, или в отдельной папке для каждой группы или в отдельной папке каждой страницы.  По умолчанию, закачка организована погруппно.%0a%0aЗакачки для всего сайта делаются так:%0a%0a->[@$UploadPrefixFmt = '';@]%0a%0aЧтобы сделать закачку постраничной, воспользуйтесь одним из двух вариантов:%0a->[@%0a$UploadPrefixFmt = '/$FullName';%0a$UploadPrefixFmt = '/$Group/$Name';%0a@]%0a%0a!!!Папка закачек%0a%0aЧтобы функция закачки работала хорошо, папка указаная в [=$UploadDir=] должна быть записываемой для процесса веб сервера и желательно, чтобы она была доступна через веб (например, в папке ''public_html'').  Выполнение PmWiki с включеными закачками выведет приглашение с перечислением шагов требуемых для создания папки закачек на вашем сервере(оно отличается от сервера к серверу).%0a%0a!!!Закачивание файлов%0a%0aС тех пор как функция закачки включена, пользователи получают доступ к диалогу закачке посредством приписывания "@@?action=upload@@" в конец обычного URL PmWiki.  Пользователю будет предлагаться ввести пароль закачки подобно паролям для других страниц (об установке паролей на страницы, группы, и весь сайт смотри [[Passwords|+]] и [[PasswordsAdmin|+]]).%0a%0aДругой способ получить диалог закачки - это вставить разметку "[@Attach:filename.ext@]" на существующую страницу, где @@filename.ext@@ это имя нового файла для закачивания.  Когда страница будет показана, '?-ссылка' будет добавлена в конце разметки для доступа автора к странице закачки.%0a%0aИзначально, PmWiki распределяет закачаные файлы по отдельным папка для каждой группы.  Это можно изменить поправив переменную $UploadPrefixFmt. Подробнее читай [[Cookbook:UploadGroups]].%0a%0a!! [[#upload_versions]] Сохранение версий закачаных файлов%0a%0aИзначально, PmWiki не поддерживает сохранение версий закачаных файлов.  Однако, установив $EnableUploadVersions=1; администратор может включить сохранение старых версий закачаных файлов в папке для закачаных файлов на равне с остальными версиями.%0a%0a%0a!! Ограничение закачки файлов для групп и страниц%0a%0aПользуясь [[подстройкой по группам -> per group customizations]] закачка файлов может быть включена только для указаных групп или страниц.  Просто установите @@$EnableUpload=1;@@ для тех групп или страниц, в которых вы желаете включить закачку; или же установите @@$EnableUpload=1;@@ в файле config.php и установите @@$EnableUpload=0;@@ в файлах подстройки групп или страниц, где вы хотите запретить закачку.%0a%0a%0a[[#restrictinguploadedfiles]]%0a!! Ограничение закачки файлов по типам и размеру%0a%0aПрежде чем сохранить закачаный файл в папку закачек сценарий выполняет ряд проверок.  Основные проверки описаны ниже:%0a:'''имя файла''': имя закачаного файла может содержать только буквы, цифры, подчёркивания, тире, пробелы и точки.  Также имя должно начинаться и заканчиваться буквой или цифрой.%0a:'''тип файла''': для закачивания на веб сервер разрешены файлы только определённых типов, таких как "@@.gif@@", "@@.jpeg@@", "@@.doc@@", и пр.  Это жизненно важно для безопасности сервера, так как веб сервер может попытаться выполнить или обработать файлы с расширениями вроде "@@.php@@", "@@.cgi@@" и т.п.  %0a:'''размер файла''': Изначально все закачки ограничены 50-ю килобайтами, что определяется переменной $UploadMaxSize.  Таким образом, для ограничения размера всех закачек сотней килобайт просто укажите новое значение для $UploadMaxSize в ''config.php'':%0a%0a->[@$UploadMaxSize = 102400;@]%0a%0aКроме того, наибольший размер файла также может быть указан для каждого типа закачиваемого файла.  Соответственно, администратор может ограничить размер файлов "@@.gif@@" и "@@.jpeg@@" 20-ю килобайтами, а все остальные типы размером из переменной $UploadMaxSize.  Массив $UploadExtSize используется для установки допустимых типов файлов и их максимального размера (в байтах).  Например:%0a%0a->[@$UploadExtSize['gif'] = 20480; # ограничить .gif файлы до 20K@]%0a%0aУстановка записи в ноль совершенно запрещает закачивать файлы этого типа:%0a%0a->[@$UploadExtSize['zip'] = 0;     # запретить .zip файлы@]%0a%0a%0a[[#newuploadfiletypes]]%0a!!Добавление новых типов файлов к списку разрешённых%0a%0aЧтобы добавить новый тип в список разрешённых типов файлов добавьте строчку подобную следующей в файл [[настройки -> local customizations]]:%0a%0a->[@$UploadExts['ext'] = 'content-type';@]%0a%0aгде ''ext'' это добавляемое расширение файла и ''content-type'' это тип содержимого (MIME тип) применяемый к файлам с таким расширением.  К примеру, для добавления расширения '[@dxf@]' с типом содержимого '[@image/x-dxf@]' добавьте строку:%0a%0a->[@$UploadExts['dxf'] = 'image/x-dxf';@]%0a%0aКаждая запись в $UploadExts должна быть расширением и mime-типов ассоциируемым с этим расширением, например так:%0a%0a->[@%0a$UploadExts = array(%0a  'gif' => 'image/gif',%0a  'jpeg' => 'image/jpeg',%0a  'jpg' => 'image/jpeg',%0a  'png' => 'image/png',%0a  'xxx' => 'yyyy/zzz'%0a)%0a@]%0a%0aНет необходимости указывать в этом списке типы файлов, которые PmWiki уже знает (сценарий ''upload.php'' добавляет умолчания PmWiki для минимальной административной поддержки).%0a%0a%0a[[#otherfilesizelimits]]%0a!!Другой предел размера файла%0a%0aЕсли и другие действующие факторы оказывающие влияние на размер закачиваемого файла.  В Apache 2.0 есть директива LimitRequestBody управляющая максимальным размеров всего что послано(posted)(включая закачку файлов).  Apache по умолчанию считает этот размер неограниченым.  Однако, некоторые дистрибутивы Linux (в т.ч. Red Had Linux) ограничивает посылку 512 килобайтами, что требует изменения или увеличения.  (Обычно эти настройки находятся в файле конфигурации ''httpd.conf'' или в файле ''/etc/httpd/conf.d''.)%0a%0aПроблема отмеченая в Red Hat 8.0/9.0 с Apache 2.0.x определяется как ошибка "Requested content-length of 670955 is larger than the configured limit of 524288" и выглядит в броузере как "Page not found"(страница не найдена).  Попытка изменить указаные выше настройки не помогает с PHP, т.к. у Red Hat 8.0/9.0 есть дополнительный файл настроек для PHP /etc/httpd/conf.d/php.conf.  Увеличение числа в строке "LimitRequestBody 524288" решает эту проблему.%0a%0aPHP сам по себе имеет два ограничения на закачку файла (часто расположеные в /etc/php.ini).  Первое - это параметр @@upload_max_filesize@@ установленый по умолчанию в 2M.  Второй -- @@post_max_size@@ со значением по умолчанию 6М.%0a%0aМаксимальный размер закачиваемого файла определяется из наименьшего значения среди трёх переменных: PmWiki наибольший размер файла, предел размера запроса Apache и параметр размера файла PHP.%0a%0a%0a!!! [[#direct_download]] Защита паролем закачаных файлов%0aУстановка пароля на просмотр для страниц(или групп) предотвращает просмотр и доступ к файлам страницы, но для закрытия прямого доступа к файлам (в папке uploads/) надо сделать следующее:%0a%0a* в local/config.php установить $EnableDirectDownload=0;%0a* Запретить доступ к папке uploads/ посредством перемещения её за пределы дерева директорий html/ или public_html/, или с помощью файла .htaccess.%0a%0aСмотри [[Cookbook:SecureAttachments]].  %0a%0a%0a!!Другие замечания%0a%0a* Если закачки всё ещё не работают, убедитесь что ваш установленый PHP позволяет закачки.  Файл ''php.ini''(часто ''/etc/php.ini'' или ''/usr/local/lib/php.ini'') должен содержать%0a%0a->[@file_uploads = On@]%0a%0aЗаметьте, что если вы измените это значение, httpd(веб сервер) должен быть перезапущен(restart).  Другой способ проверить разрешённость закачек на сервере это установить $EnableDiag в 1 (''config.php'') и вызвать любую страницу с ?action=phpinfo  в URL.  Переменная "@@file_uploads@@" должна иметь значение 1 (если её значение "@@no value@@", то это значит - выключено).%0a%0a%25trail%25%3c%3c|[[Documentation Index|+]]|>>%0a>>faq%3c%3c [[#faq]]%0a%0aQ: Как мне запретить закачку файлов определённого типа?%0aA: Вот пример чего надо добавить в ваш файл ''local/config.php'' для запрета закачавания .zip файлов:%0a%0a[@$UploadExtSize['zip'] = 0;  # Запрет закачки .zip файлов.@]%0a
time=1146552321
title=Управление закачками
